
ECPaaS自動化測試VM

1	INTRODUCTION
1.1	Overview
介紹如何使用python測試自動建立VM方法。

2	REFERENCE
2.1	參考文件
1.	https://pypi.org/project/paramiko/

3	測試自動建立VM及驗證連線
3.1	前置作業
3.1.1	系統版本資訊
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=20.04
DISTRIB_CODENAME=focal
DISTRIB_DESCRIPTION="Ubuntu 20.04.6 LTS"
3.1.2	IMAGE
https://cloud-images.ubuntu.com/

可以在這邊找需要的官方版本 image 來作客製化，
按需求選擇下載適合版本的 IMAGE，EX:

wget https://cloud-images.ubuntu.com/releases/focal/release/ ubuntu-20.04-server-cloudimg-amd64.img

PS: 範例是用 20.04 版本。

3.1.3	工具程式
以下步驟會用到的工具程式，可以先裝好備用。

1.	Python 3.8.10
2.	pip 24.2 (python 3.8)
3.	paramiko 3.4.1 (pkg: python package)
4.	系統要有curl的指令


3.2	起動測試方法及內容
1.	先在本地目錄放置要上傳的 image及程式
Image:
ubuntu-20.04-server-cloudimg-amd64.img

單一建立VM的程式:
build_vm1.py

可配置建立VM參數的程式:
build_vm_many.py

清除所有虛擬化的image, data volume, VM
remove_vm.py

建立可配置VM參數:
vm_config.ini
[vm]
cpu=1
ram=2
system_disk_size=20
template_name=t-name
host_name=h
namespace=def-vm
data_disk_name=data
data_disk_size=10
[host_num]
num=2

2.	起動要測試指令
python3 build_vm1.py admin:Abcd1234 192.168.42.212 bionic-server-cloudimg-i386.img

python3 build_vm_many.py admin:Abcd1234 192.168.42.212 bionic-server-cloudimg-i386.img

python3 remove_vm.py admin:Abcd1234 192.168.42.212

起動測試參數:
測試程式名稱:    build_vm1.py
user:password: admin:Abcd1234(集群登入user/password)
Host IP(k8s):  192.168.42.212
上傳image file: bionic-server-cloudimg-i386.img


3.3	測試程式執行步驟
build_vm1.py
1.	Step 1: Check upload bionic-server-cloudimg-i386.img file
2.	step 1.1: Start upload bionic-server-cloudimg-i386.img file
3.	step 1.2: Check upload file size
4.	Step2:create template image with bionic-server-cloudimg-i386.img
5.	Step2.1:Check virtual machine status from image-a355c791
6.	Step3:Create a virtual machine template by image-a355c791
7.	Step4:Check virtual machine status from vm-90b5756c
8.	Step5:Get the virtual machine IP from vm-90b5756c
9.	Step6:Test whether the PING of the virtual machine is passed from 10.233.127.173
10.	Step7:Get all PVC data
11.	Step8:Create Data disk of VM
12.	Step9:Check new PVC status
13.	Step10:Check VM
14.	Step10.1:Mount data dick on VM
15.	Step11:Check vm mount disk status
16.	Step12:Confirm whether the virtual machine has been mounted with PVC
17.

build_vm_many.py
1.	Step1:Check upload image file
2.	Step1.1:Start upload image file
3.	Step1.2:Check upload file size
4.	Step2:create template image
5.	Step2.1:Check virtual machine status from image-d8615e8a
6.	Step3:Create a virtual machine template by image-d8615e8a
7.	Step4:Check virtual machine status from list id
8.	Step5:Get the virtual machine IP from list id
9.	Step6:Test whether the PING of the virtual machine is passed
10.	Step7:SSH connection test
11.	Step8:Get all PVC data
12.	Step9:Create Data disk of VM
13.	Step10:Check new PVC status
14.	Step11:Check VM
15.	Step12:Mount data dick on VM
16.	Step13:Check vm mount disk status
17.	Step14:Check data volume status
18.	Step15:Get the virtual machine IP from list id again
19.	Step16:Confirm whether the virtual machine has been mounted with PVC
20.

3.4	FAQ
3.5.1	上傳要製作範本的img
測試前可以先透過ecpaas的WeB介面上傳要製作範本的檔案, 讓檔案先存在ecpaas的集群中, 自動測試會先判斷要製作範本的檔案是否巳經存在集群中, 如果不存在, 會由本地的目錄上傳製作範本的檔案

3.6.2	測試中的重試
在測試步驟中, 有些測試會自動重試自集群中取得測試下一步驟所需要的條件, 所以測試步驟中會有一些重覆訊息
3.6.3	測試中的認證錯誤
在測試中如果執行curl在認證錯誤會(openssl / x501…), 而python不能執行pip list時, 可能是認證出錯, 可以執行如下:
sudo apt-get remove python3
sudo apt-get install python3
sudo apt-get upgrade openssl
sudo apt-get install python3-pip
將python3及pip重安裝

